## visiond

### desc

There's an arbitrary length/content overflow in /system/bin/visond 


1. We use first transact with code=3 from untrusted_app to /system/bin/visond service, to trigger android::AIRService::Client::configure(int)
in libairservice.so. This transact is needed to init some parameters
2. The second transact with code=4, which starts an AIRService Client, android::AIRService::Client::start()
start the Client to accept the final transaction, which triggers the vulnerability.
3. The final transact, with code=7, actually passes an IMemory with attacker controlled length/content, 
to trigger android::AIRService::Client::enqueueFrame(int, android::sp<android::IMemory> const&).

This function actually first calls android::FrameManager::Frame::getData(), which creates a fixed-size
2*1024*1024 byte IMemory, to accept the IMemory passed in from client.

However, since the accepting IMemory is fixed size, we can craft a very large IMemory, which the code in enqueueFrame
will blindly copy into 2*1024*1024 IMemory with our passed in length and content, lead to overflow.


Related decompiled code:
  v5 = systemTime(1LL);
  android::FrameManager::Frame::Frame(frame, v5, v2->oword88, DWORD1(v2->oword88), 17, DWORD2(v2->oword88));
  v16 = frame;
  android::RefBase::incStrong(frame, &v16);
  (*(void (**)(void))(**(_QWORD **)v3 + 0x20LL))();
  incomebuf = (void *)(*(__int64 (**)(void))(*(_QWORD *)v16 + 88LL))();
  v7 = (*(__int64 (__fastcall **)(__int64))(*(_QWORD *)imemoryheap + 40LL))(imemoryheap);
  memcpy(incomebuf, (const void *)(v7 + v15), v14);
  pthread_mutex_lock(v2->gap300);


Our poc is in Java, so we use dummy.bin and java-side emulated class acting as IMemory, reading from a file,
 which was first used in Project Zero's Android IMemory exploit. You can also rewrite the poc in C++ to use real IMemory to
trigger this vuln.

Tombstones:

11-08 16:49:05.660 15743 15753 F libc    : Fatal signal 11 (SIGSEGV), code 2, fault addr 0x7f9d51b000 in tid 15753 (Binder:15743_1)
11-08 16:49:05.660   516   516 W         : debuggerd: handling request: pid=15743 uid=1000 gid=1000 tid=15753
11-08 16:49:05.730 15966 15966 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
11-08 16:49:05.730 15966 15966 F DEBUG   : Build fingerprint: 'samsung/dreamqlteue/dreamqlteue:7.0/NRD90M/G950U1UEU1AQH3:user/release-keys'
11-08 16:49:05.730 15966 15966 F DEBUG   : Revision: '12'
11-08 16:49:05.731 15966 15966 F DEBUG   : ABI: 'arm64'
11-08 16:49:05.731 15966 15966 F DEBUG   : pid: 15743, tid: 15753, name: Binder:15743_1  >>> /system/bin/visiond <<<
11-08 16:49:05.731 15966 15966 F DEBUG   : signal 11 (SIGSEGV), code 2 (SEGV_ACCERR), fault addr 0x7f9d51b000
11-08 16:49:05.731 15966 15966 F DEBUG   :     x0   0000007f9d2e1000  x1   0000007f9cb1b030  x2   00000000007c5f80  x3   0000000000a00000
11-08 16:49:05.731 15966 15966 F DEBUG   :     x4   0000000000000000  x5   bea17f9958545531  x6   0000007f9d51aff0  x7   0706050403020100
11-08 16:49:05.731 15966 15966 F DEBUG   :     x8   0f0e0d0c0b0a0908  x9   1716151413121110  x10  1f1e1d1c1b1a1918  x11  2726252423222120
11-08 16:49:05.731 15966 15966 F DEBUG   :     x12  2f2e2d2c2b2a2928  x13  3736353433323130  x14  3f3e3d3c3b3a3938  x15  0000007fa5f06c40
11-08 16:49:05.731 15966 15966 F DEBUG   :     x16  0000007f9ed61560  x17  0000007fa5db6ec8  x18  0000000000000000  x19  0000007fa5651400
11-08 16:49:05.731 15966 15966 F DEBUG   :     x20  0000007f9d2e1000  x21  0000007fa55010e0  x22  bea17f9958545531  x23  0000000000000007
11-08 16:49:05.731 15966 15966 F DEBUG   :     x24  bea17f9958545531  x25  0000000000000000  x26  0000000000000000  x27  bea17f9958545531
11-08 16:49:05.731 15966 15966 F DEBUG   :     x28  0000000000000000  x29  0000007fa5501070  x30  0000007f9ed3f654
11-08 16:49:05.731 15966 15966 F DEBUG   :     sp   0000007fa5501010  pc   0000007fa5db7014  pstate 0000000020000000
11-08 16:49:05.736 15966 15966 F DEBUG   :
11-08 16:49:05.736 15966 15966 F DEBUG   : backtrace:
11-08 16:49:05.736 15966 15966 F DEBUG   :     #00 pc 000000000001b014  /system/lib64/libc.so (memcpy+332)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #01 pc 000000000002a650  /system/lib64/libairservice.so (_ZN7android12FrameManager12enqueueFrameERKNS_2spINS_7IMemoryEEE+188)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #02 pc 0000000000031870  /system/lib64/libairservice.so (_ZN7android10AIRService6Client12enqueueFrameEiRKNS_2spINS_7IMemoryEEE+72)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #03 pc 000000000000fbf8  /system/lib64/libair.so (_ZN7android5BnAIR10onTransactEjRKNS_6ParcelEPS1_j+732)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #04 pc 000000000004a340  /system/lib64/libbinder.so (_ZN7android7BBinder8transactEjRKNS_6ParcelEPS1_j+132)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #05 pc 00000000000564f0  /system/lib64/libbinder.so (_ZN7android14IPCThreadState14executeCommandEi+1032)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #06 pc 000000000005602c  /system/lib64/libbinder.so (_ZN7android14IPCThreadState20getAndExecuteCommandEv+156)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #07 pc 0000000000056710  /system/lib64/libbinder.so (_ZN7android14IPCThreadState14joinThreadPoolEb+76)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #08 pc 0000000000074b70  /system/lib64/libbinder.so
11-08 16:49:05.736 15966 15966 F DEBUG   :     #09 pc 00000000000127f0  /system/lib64/libutils.so (_ZN7android6Thread11_threadLoopEPv+336)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #10 pc 00000000000770f4  /system/lib64/libc.so (_ZL15__pthread_startPv+204)
11-08 16:49:05.736 15966 15966 F DEBUG   :     #11 pc 000000000001e7d0  /system/lib64/libc.so (__start_thread+16)
11-08 16:49:05.798 15966 15966 E         : ro.debug_level = 0x4f4c
11-08 16:49:05.798 15966 15966 E         : sys.mobilecare.preload = false